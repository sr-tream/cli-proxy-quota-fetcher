# CLIProxyAPI Quota Fetcher

> **⚠️ Note:** This project was generated by an AI assistant (GLM-4.7). The code and documentation are provided as-is and may need human review and adaptation for production use.

Simple TypeScript scripts to fetch quota information from all configured CLIProxyAPI auth providers.

## Requirements

- [Deno](https://deno.land/) (TypeScript runtime)

## Installation

```bash
chmod +x quota-simple.ts balanced-quota.ts
```

## Scripts

### quota-simple.ts

Fetches quota information from all configured auth providers and returns a consolidated JSON output.

#### Basic usage

```bash
deno run quota-simple.ts <CLIProxyAPI_MANAGEMENT_KEY>
```

#### Custom API base URL

```bash
deno run quota-simple.ts sk-1234 http://127.0.0.1:8317/v0/management
```

#### Quiet mode (only JSON output)

```bash
# Suppress all non-JSON output (useful for piping)
deno run quota-simple.ts -q sk-1234

# Save to file without info messages
deno run quota-simple.ts -q sk-1234 > quotas.json
```

### balanced-quota.ts

Calculates balanced quotas across providers by grouping models with the same name and computing the average quota value.

#### Usage

```bash
deno run balanced-quota.ts <CLIProxyAPI_MANAGEMENT_KEY> [BASE_URL]
```

#### Example

```bash
# Using default localhost URL
deno run balanced-quota.ts sk-1234

# Using custom URL
deno run balanced-quota.ts sk-1234 http://127.0.0.1:8317/v0/management
```

#### Output format

The script outputs a JSON object with model names as keys and balanced quota values as floats:

```json
{
  "claude-sonnet-4.5": 0.7733333,
  "gemini-2.5-flash": 0.99966665,
  "gemini-2.5-flash-lite": 0.99966665,
  ...
}
```

Where the value is calculated as the average of quotas from all providers that have the same model (e.g., `(1 + 0.9993333) / 2 = 0.99966665`).

## Examples

### Check your quotas

```bash
# Using default localhost URL (shows progress messages)
deno run quota-simple.ts sk-1234

# Using quiet mode (only JSON)
deno run quota-simple.ts -q sk-1234

# Using custom URL with quiet mode
deno run quota-simple.ts -q sk-1234 http://127.0.0.1:8317/v0/management

# Get balanced quotas across providers
deno run balanced-quota.ts sk-1234
```

### Custom API base URL

```bash
deno run quota-simple.ts sk-1234 http://127.0.0.1:8317/v0/management
```

## Examples

### Check your quotas

```bash
# Using default localhost URL
deno run quota-simple.ts sk-1234

# Using custom URL
deno run quota-simple.ts sk-1234 http://192.168.1.100:8317/v0/management
```

### Parse quota from JSON output

```bash
# Get all quotas as JSON
deno run quota-simple.ts sk-1234 > quotas.json

# Get successful quota counts
deno run quota-simple.ts sk-1234 | jq '.results[] | select(.status == "success")'

# Get antigravity quota percentage
deno run quota-simple.ts sk-1234 | jq '.results[] | select(.provider == "antigravity") | .quota."claude-sonnet-4-5".remainingFraction'
```

## Output Format

The script outputs JSON to stdout:

```json
{
  "timestamp": "2026-01-06T12:30:26.441Z",
  "baseUrl": "http://127.0.0.1:8317/v0/management",
  "results": [
     {
      "provider": "antigravity",
      "authIndex": "xxxxxxxxxxxxxxxx",
      "label": "user@example.com",
      "status": "success",
      "quota": {
        "gemini-2.5-flash": {
          "displayName": "Gemini 2.5 Flash",
          "remainingFraction": 1,
          "resetTime": "2026-01-06T17:30:24Z"
        },
        "claude-sonnet-4-5": {
          "displayName": "Claude Sonnet 4.5",
          "remainingFraction": 0.7733333,
          "resetTime": "2026-01-06T15:44:58Z"
        }
      },
      "timestamp": "2026-01-06T12:30:24.491Z"
    }
  ]
}
```

## Supported Providers

- **antigravity**: Gemini 2.5/3.x models, Claude 4.5, GPT-OSS
- **gemini-cli**: Gemini CLI project quotas
- **codex**: ChatGPT Codex usage limits

## Exit Codes

- `0`: All quotas fetched successfully
- `1`: Error occurred (one or more quota fetches failed)

## Constants

The script uses API constants from:
https://raw.githubusercontent.com/router-for-me/Cli-Proxy-API-Management-Center/refs/heads/main/src/utils/quota/constants.ts

Including:
- API endpoints for each provider
- Request headers with `$TOKEN$` placeholder substitution
- Quota grouping definitions

## Script Features

- ✅ Fetches quota from all configured providers
- ✅ Handles multiple auth files per provider
- ✅ Skips disabled auth files
- ✅ Falls back to alternative URLs for antigravity
- ✅ Returns structured JSON output (always to stdout)
- ✅ All non-JSON output goes to stderr
- ✅ `-q` quiet flag for pure JSON output
- ✅ Reports errors to stderr for logging
- ✅ Exit code indicates success/failure
- ✅ Pipe-friendly (JSON to stdout, info to stderr)
